name: Deploy to VPS

on:
  push:
    branches:
      - main # หรือ master (เช็คชื่อ branch หลักของคุณด้วย)

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.KEY }}
          port: 22
          script: |
            # เข้าไปที่โฟลเดอร์โปรเจกต์
            cd ~/introduction-myself

            # ดึงโค้ดล่าสุดจาก GitHub (บังคับทับของเดิม)
            git fetch --all
            git reset --hard origin/main

            # สั่ง Docker Build และ Run ใหม่
            docker compose up -d --build

            # ลบ Image ขยะที่ไม่ได้ใช้แล้ว
            docker image prune -f
